# 飞书文档内容读取器 Chrome 插件

这是一个 Chrome 浏览器插件，可以读取飞书文档的内容并以多种格式展示，支持复制和下载。

## 功能特点

- 读取飞书文档内容
- 支持多种输出格式：Markdown、纯文本、HTML
- 一键复制文档内容
- 下载为文件
- **用户授权**：支持OAuth用户授权，可访问你有权限的私密文档
- 美观的用户界面

## 安装步骤

### 1. 准备图标文件

由于技术限制，插件需要 PNG 格式的图标文件。请将以下尺寸的图标文件放入 `icons` 目录：

- `icon16.png` - 16x16 像素
- `icon48.png` - 48x48 像素
- `icon128.png` - 128x128 像素

你可以使用 `icons/icon.svg` 作为参考，将其转换为 PNG 格式。

### 2. 在 Chrome 中安装插件

1. 打开 Chrome 浏览器
2. 在地址栏输入 `chrome://extensions/` 并回车
3. 打开右上角的"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择此插件所在的目录 `larkdoccc`
6. 插件安装完成

### 3. 获取飞书应用凭据

在使用插件之前，你需要创建一个飞书应用并获取凭据：

**⚠️ 重要：应用创建区域必须与文档区域匹配**

| 文档区域 | 文档域名示例 | 应用创建平台 | API端点 |
|---------|-------------|-------------|---------|
| 中国版 | xxx.feishu.cn | https://open.feishu.cn | https://open.feishu.cn |
| 国际版 | xxx.larksuite.com | https://open.larksuite.com | https://open.larksuite.com |
| 新加坡版 | xxx.larkoffice.com | https://open.larksuite.com | https://open.larksuite.com |

#### 创建应用步骤（以新加坡版为例）：

1. **访问对应区域的开放平台**
   - 新加坡版/国际版：访问 [https://open.larksuite.com/](https://open.larksuite.com/)
   - 中国版：访问 [https://open.feishu.cn/](https://open.feishu.cn/)

2. **创建企业自建应用**
   - 选择"创建企业自建应用"
   - 填写应用名称和描述

3. **获取凭据**
   - 在应用详情页获取 `App ID` 和 `App Secret`

4. **配置权限**
   - 进入"权限管理"
   - 添加以下权限并**申请发布**：
     - `docx:document` - 查看云文档内容（必需）
     - 或者 `docx:document:readonly` - 只读访问文档
   - 等待权限审批通过

5. **配置重定向URL（用于用户授权）**

   在飞书开放平台配置的重定向URL：
   ```
   http://localhost:8080/callback
   ```

   **注意**：
   - 插件会通过监听窗口URL变化来捕获授权码
   - 不需要实际运行本地服务器
   - 这个URL仅用于满足飞书的验证要求

6. **发布应用**
   - 方式1：正式发布应用（需要企业管理员审批）
   - 方式2：开启"测试版本"，邀请自己作为测试用户

**注意**：
- 应用创建的区域必须与文档所在区域一致
- 中国版的应用无法访问新加坡/国际版的文档，反之亦然
- 应用必须是"企业自建应用"

## 使用方法

### 方式1：应用身份访问（仅限公开文档）

1. **配置应用凭据**
   - 点击浏览器工具栏中的插件图标
   - 输入你的飞书应用的 `App ID` 和 `App Secret`
   - 点击"保存配置"

2. **获取文档内容**
   - 打开任意飞书文档
   - 点击插件图标
   - 点击"获取文档内容"按钮
   - 等待内容加载完成

**注意**：应用身份只能访问应用有权限的文档（通常是公开文档）。

### 方式2：用户授权访问（可访问私密文档）✨ 推荐

1. **配置应用凭据**
   - 同方式1

2. **用户授权**
   - 点击插件图标中的"用户登录授权"按钮
   - 在打开的页面中完成飞书账号授权
   - 授权成功后会显示已授权状态和用户信息

3. **获取文档内容**
   - 打开任意你有权限的飞书文档（包括私密文档）
   - 点击插件图标
   - 点击"获取文档内容"按钮
   - 插件会自动使用你的用户身份获取文档

### 导出文档

- 选择输出格式（Markdown/纯文本/HTML）
- 点击"复制内容"复制到剪贴板
- 或点击"下载文件"保存到本地

## 项目结构

```
larkdoccc/
├── manifest.json       # 插件配置文件
├── popup.html          # 弹出界面
├── popup.css           # 界面样式
├── popup.js            # 弹出界面逻辑
├── content.js          # 内容脚本
├── background.js       # 后台服务和OAuth处理
├── oauth.html          # OAuth授权回调页面
├── icons/              # 图标目录
│   ├── icon.svg        # SVG 图标
│   ├── icon16.png      # 16x16 图标
│   ├── icon48.png      # 48x48 图标
│   └── icon128.png     # 128x128 图标
└── README.md           # 说明文档
```

## API 使用说明

本插件使用飞书开放平台的以下 API：

- 获取租户访问令牌: `POST /open-apis/auth/v3/tenant_access_token/internal`
- 获取文档元数据: `GET /open-apis/docx/v1/documents/{document_id}`
- 获取文档块列表: `GET /open-apis/docx/v1/documents/{document_id}/blocks/{block_id}/children`

详细 API 文档请参考：https://open.feishu.cn/document/server-docs/docs/docs-v1

## 注意事项

1. **权限要求**: 飞书应用必须具有"查看云文档内容"权限
2. **访问限制**: 只能访问你有权限查看的文档
3. **令牌管理**: 访问令牌会自动缓存，避免频繁请求
4. **安全性**: App Secret 仅存储在本地浏览器中

## 故障排除

### 无法获取文档内容

#### 错误：获取文档元数据失败: forBidden (code: 99991663)

这是最常见的错误，表示权限不足。请检查：

1. **权限配置**
   - 登录飞书开放平台，进入你的应用
   - 检查"权限管理"中是否已添加 `docx:document` 权限
   - 确认权限状态为"已通过"或"已生效"

2. **应用类型**
   - 确保应用类型为"企业自建应用"
   - 个人自建应用可能无法使用文档API

3. **应用发布状态**
   - 应用必须已发布或在测试模式中
   - 如果使用测试模式，确保你已被添加为测试用户

4. **文档访问权限**
   - 确认你的飞书账号有权限访问该文档
   - 如果文档是私密的，需要文档所有者授权

5. **租户访问令牌**
   - 当前使用租户访问令牌，需要应用级权限
   - 某些文档可能需要用户授权（需要实现OAuth流程）

#### 其他错误

**错误：获取访问令牌失败**
- 检查 App ID 和 App Secret 是否正确
- 确认应用未被禁用或删除
- 确认应用创建区域与文档区域一致

**错误：无法获取文档ID**
- 确保在飞书文档页面（URL包含 docx、docs、wiki 或 note）
- 点击"调试信息"查看当前页面状态

### OAuth授权问题

**授权页面打不开或显示错误（20029错误）**

这是重定向URL配置错误，请修复：

1. 在飞书开放平台进入"应用设置" → "重定向URL"
2. 添加重定向URL：`http://localhost:8080/callback`
3. 保存配置并重新加载插件

**说明**：插件会通过监听授权窗口的URL变化来捕获授权码，不需要实际运行本地服务器。

**授权后仍然无法访问私密文档**
- 确认授权成功（插件显示已授权状态）
- 刷新插件页面重新检查授权状态
- 确认你的账号确实有该文档的访问权限

**授权失败或被取消**
- 重新点击"用户登录授权"按钮
- 确保在授权页面点击"同意授权"
- 检查浏览器控制台是否有错误信息

## 开发者

本项目由 Claude Code 创建。

## 许可证

MIT License
